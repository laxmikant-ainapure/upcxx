#!/usr/bin/env python
import os
import argparse

if __name__ == "__main__":

    path = os.path.dirname(os.path.realpath(__file__))

    parser = argparse.ArgumentParser()
    parser.add_argument("--gasnetFetch",
                        help="Fetch and build GASNet matching this UPC++ Release [default=no]",
                        default="no")
    parser.add_argument("--gasnet",
                        help="location of existing GASNet installation [default=/usr/local/gasnet]",
                        default="/usr/local/gasnet")
    parser.add_argument("--conduit",
                        help="which GASNet conduit will UPC++ use [default to sole conduit if GASNet has only a single conduit installed]",
                        default="udp")
    parser.add_argument("--defines",
                        help="preprocessing macros: -Dxx -Dyy",
                        default="")
    parser.add_argument("--undefines",
                        help="preprocessing macros to be undefined",
                        default="")
    parser.add_argument("--CC",
                        help="C++ compiler",
                        choices=["$(GASNET_CXX)","CC","g++","icpc","clang++","xlC"],
                        default="$(GASNET_CXX)")
    parser.add_argument("--cc",
                        help="C compiler",
                        choices=["$(GASNET_CC)","cc","gcc","icc","clang","xlc"],
                        default="$(GASNET_CC)")
    parser.add_argument("--prefix",
                        help=" location where headers and library are installed",
                        default=".")
    parser.add_argument("--debug",
                         help="build with debug symbols and extra diagnostics [defualt=no]",
                         choices=["yes","no"],
                         default="no")
    args = parser.parse_args()

    f = open("GNUmakefile","w")
    
    f.write("GASNET_DIR = " +args.gasnet.strip() + "\n")
    f.write("GASNET_CONDUIT = " +args.conduit.strip() +"\n")
    f.write("UPCXX_INSTALL_DIR = " + args.prefix.strip() + "\n")
    f.write("SRC_DIR= "+path+"/src/\n")
    f.write("CXX = " + args.CC.strip() + "\n")
    f.write("CC = " + args.cc.strip() + "\n")
    if args.debug == "yes":
	f.write("CXXFLAGS=-g \n")
    else:
	f.write("CXXFLAGS=-O3 \n")
    
    fin = open(path+"/GNUmakefile.in","r")
    for line in fin.readlines():
        f.write(line)
    fin.close()

    f.close()

    f=open("upcxx_config.hpp","w")
    if args.debug == "yes":
        f.write("#define GASNET_DEBUG  \n #define UPCXX_DEBUG \n")
    f.close()
